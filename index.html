<html>

<head>
	<title>OneMap 2.0</title>

	<link rel="stylesheet" href="./assets/leaflet.css" />
	<link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
	<link rel="stylesheet" href="./assets/memu.css">

	<script src="./library/leaflet.js"></script>
	<script src="./library/jquery.min.js"></script>
	<script src="./library/leaflet-providers-added-onemap.js"></script>
	<script src="./library/Polyline.encoded.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</head>

<body>
	<div id="sidebar" class="sidebar-expanded">
		<li class="menu-item toggle" onclick="toggleSidebar()">
			<i class="ri-arrow-right-s-line arrow-rotate" id="arrow-icon"></i>
		</li>
		<ul class="main-feature" id="main-feature">
			<li class="menu-item" onclick="toggleOptionTraffic()">
				<i class="ri-compass-discover-line"></i>
				<span id="menu-text-t" class="menu-text">Traffic Info</span>
				<div class="inline-arrow inline-arrow-rotate" id="traffic-arrow">
					<i class="ri-arrow-right-s-line"></i>
				</div>
			</li>
			<li class="sub-menu-traffic-expanded" id="traffic-expanded">
				<div style="height: 0;">
					<i class="ri-send-plane-line"></i>
					<span>Enter starting point:</span>
					<input class="input-style" type="text" id="starting-point" placeholder="coordinate or place name"
						v-model="username" required><br>
					<i class="ri-send-plane-line"></i>
					<span>Enter destination:</span>
					<input class="input-style" type="text" id="destination" placeholder="coordinate or place name"
						v-model="password" required><br>
				</div>
				<button class="button-style" type="submit" onclick="submit()">Searching</button>
			</li>
			<li class="menu-item" onclick="toggleOptionHistory()">
				<i class="ri-history-line"></i>
				<span id="menu-text-h" class="menu-text">History</span>
				<div class="inline-arrow inline-arrow-rotate" id="history-arrow">
					<i class="ri-arrow-right-s-line"></i>
				</div>
			</li>
			<li class="sub-menu-history" id="history-expanded">
				<!-- Add History Submenu Content Here -->
			</li>
			<li class="menu-item" onclick="toggleOptionLocation()">
				<i class="ri-user-location-line"></i>
				<span id="menu-text-l" class="menu-text">Current Location</span>
				<div class="inline-arrow inline-arrow-rotate" id="location-arrow">
					<i class="ri-arrow-right-s-line"></i>
				</div>
			</li>
			<li class="sub-menu-location" id="location-expanded">
				<!-- Add Current Location Submenu Content Here -->
			</li>
		</ul>
	</div>

	<div id='mapdiv' class="map-style-begame"></div>

	<script src="./work/initmap.js"></script>
	<script src="./work/call_db.js"></script>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
			// 加载initmap.js脚本
			var script = document.createElement('script');
			script.src = './work/initmap.js';
			script.onload = function () {
				console.log('initmap.js loaded');
				// 在initmap.js加载完成后执行回调函数
				loadCallDBScript();
			};
			document.head.appendChild(script);
		});

		function loadCallDBScript() {
			// 加载call_db.js脚本
			var script = document.createElement('script');
			script.src = './work/call_db.js';
			script.onload = function () {
				console.log('call_db.js loaded');
				// 在call_db.js加载完成后执行逻辑
				// ...
			};
			document.head.appendChild(script);
		}
	</script>

	<script>
		let isExpanded = true;
		let isTrafficExpanded = true;
		let isHistoryExpanded = true;
		let isLocationExpanded = true;
		let ismapExpanded = true;
		function toggleSidebar() {
			const mapContainer = document.getElementById('mapdiv');
			mapContainer.classList.toggle('map-style-begame');

			const mainFeature = document.getElementById('sidebar');
			mainFeature.classList.toggle('sidebar-collapsed');

			const arrowIcon = document.getElementById('arrow-icon');
			arrowIcon.classList.toggle('arrow-rotate');

			menuText = document.getElementById('menu-text-t');
			menuText.classList.toggle('hidden');
			menuText = document.getElementById('menu-text-h');
			menuText.classList.toggle('hidden');
			menuText = document.getElementById('menu-text-l');
			menuText.classList.toggle('hidden');

			menuText = document.getElementById('traffic-arrow');
			menuText.classList.toggle('hidden');
			menuText = document.getElementById('history-arrow');
			menuText.classList.toggle('hidden');
			menuText = document.getElementById('location-arrow');
			menuText.classList.toggle('hidden');

			menuFeature = document.getElementById('main-feature');
			menuFeature.classList.toggle('not-expand');

			// mapfeature = document.getElementById('mapdiv');
			// mapfeature.classList.toggle('map-style')

			if (isHistoryExpanded) toggleOptionHistory();
			if (isTrafficExpanded) toggleOptionTraffic();
			if (isLocationExpanded) toggleOptionLocation();
			if (ismapExpanded) togglemap();

			isExpanded = !isExpanded;
		}

		function togglemap(){
			if (isExpanded) {
				mapContainer.classList.remove('map-style-begame');
				mapContainer.classList.add('map-style-collapsed');
			}
		}

		function toggleOptionTraffic() {
			if (isExpanded) {
				const trafficExpanded = document.getElementById('traffic-expanded');
				trafficExpanded.classList.toggle('sub-menu-traffic-expanded');

				const trafficArrow = document.getElementById('traffic-arrow');
				trafficArrow.classList.toggle('inline-arrow-rotate');

				// 获取"Traffic Info"子菜单中的内容元素
				const contentElements = trafficExpanded.querySelectorAll('input, button, span, .ri-send-plane-line');

				// 遍历内容元素并切换其可见性
				for (const element of contentElements) {
					element.classList.toggle('hidden');
				}
				isTrafficExpanded = !isTrafficExpanded;
			}
		}

		function toggleOptionHistory() {
			if (isExpanded) {
				const historyExpanded = document.getElementById('history-expanded');
				historyExpanded.classList.toggle('sub-menu-history');

				const historyArrow = document.getElementById('history-arrow');
				historyArrow.classList.toggle('inline-arrow-rotate');
				isHistoryExpanded = !isHistoryExpanded;
			}
		}

		function toggleOptionLocation() {
			if (isExpanded) {
				const locationExpanded = document.getElementById('location-expanded');
				locationExpanded.classList.toggle('sub-menu-location');

				const locationArrow = document.getElementById('location-arrow');
				locationArrow.classList.toggle('inline-arrow-rotate');
				isLocationExpanded = !isLocationExpanded;
			}
		}

		function submit() {
			const startingPointInput = document.getElementById('starting-point');
			const destinationInput = document.getElementById('destination');

			const startingPoint = startingPointInput.value;
			const destination = destinationInput.value;
			console.log(startingPoint);
			console.log(destination);

			var location_1 = startingPoint;
			var location_2 = destination;
			// const startingPointCoords = startingPoint.split(',');
			// const destinationCoords = destination.split(',');
			// var location = "Singapore";

            // 调用API的端点URL
            var apiUrl = "https://developers.onemap.sg/";

            // 构建API请求URL
            var requestUrl_1 = apiUrl + "commonapi/search?searchVal=" + location_1 + "&returnGeom=Y&getAddrDetails=Y&pageNum=1";

            // 发送GET请求
            $.get(requestUrl_1, function (data) {
                console.log(data);
                // 提取LATITUDE和LONGITUDE信息
                window.startingPointLatitude = data.results[0].LATITUDE;
                window.startingPointLongitude = data.results[0].LONGITUDE;

                // var resultText = "Latitude: " + latitude + "<br>Longitude: " + longitude;
                // $("#result").html(resultText);
                
            });

            var requestUrl_2 = apiUrl + "commonapi/search?searchVal=" + location_2 + "&returnGeom=Y&getAddrDetails=Y&pageNum=1";
			$.get(requestUrl_2, function (data) {
                console.log(data);
                // 提取LATITUDE和LONGITUDE信息
                window.destinationLatitude = data.results[0].LATITUDE;
                window.destinationLongitude = data.results[0].LONGITUDE;

                // var resultText = "Latitude: " + latitude + "<br>Longitude: " + longitude;
                // $("#result").html(resultText);
                
            });

			// window.startingPointLatitude = parseFloat(startingPointCoords[0]);
			// window.startingPointLongitude = parseFloat(startingPointCoords[1]);
			// window.destinationLatitude = parseFloat(destinationCoords[0]);
			// window.destinationLongitude = parseFloat(destinationCoords[1]);

			console.log('Starting Point Latitude:', window.startingPointLatitude);
			console.log('Starting Point Longitude:', window.startingPointLongitude);
			console.log('Destination Latitude:', window.destinationLatitude);
			console.log('Destination Longitude:', window.destinationLongitude);


			Routing();
		}
		// var startlat = '1.30000';
		// var startlng = '103.84223';
		// var endlat = '1.31801';
		// var endlng = '103.84224';
		// 1.30000,103.84223
		// 1.31801,103.84224

		function Routing() {

			var startlat = window.startingPointLatitude;
			var startlng = window.startingPointLongitude;
			var endlat = window.destinationLatitude;
			var endlng = window.destinationLongitude;

			console.log(startlat);
			console.log(endlat);

			getRoute();

			function getRoute() {

				var api_token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjEwNTU4LCJ1c2VyX2lkIjoxMDU1OCwiZW1haWwiOiJjaGVuZ2hhbmcwNTE2QDE2My5jb20iLCJmb3JldmVyIjpmYWxzZSwiaXNzIjoiaHR0cDpcL1wvb20yLmRmZS5vbmVtYXAuc2dcL2FwaVwvdjJcL3VzZXJcL3Nlc3Npb24iLCJpYXQiOjE2ODk2NjM1MjEsImV4cCI6MTY5MDA5NTUyMSwibmJmIjoxNjg5NjYzNTIxLCJqdGkiOiIxMDFkNDMxNWQwOTNhMGM3ZmEzNDExOGJjYTNkNWVjZiJ9.-GmctpGP-J4BRaVmziNXrV7EBmEdxNSeL8uu2gzMe8I'; // 替换为您的API Token

				var url = `https://developers.onemap.sg/privateapi/routingsvc/route?start=${startlat},${startlng}&end=${endlat},${endlng}&routeType=drive&token=${api_token}`;

				$.ajax({
					url: url,
					type: 'GET',
					success: function (response) {
						// 处理响应数据
						console.log(response);
						decodeGeometry(response);
						// 在这里根据返回的数据进行相应的操作
					},
					error: function (error) {
						console.log('请求失败:', error);
					}
				});
			};

			function decodeGeometry(sampleRoute) {

				var center = L.bounds([startlat, startlat], [endlat, endlat]).getCenter();

				//图标生成与颜色设置   
				var goldIcon = new L.Icon({
					iconUrl: './images/marker-icon-gold.png',
					shadowUrl: './images/marker-shadow.png',
					iconSize: [25, 41],
					iconAnchor: [12, 41],
					popupAnchor: [1, -34],
					shadowSize: [41, 41]
				});

				var blackIcon = new L.Icon({
					iconUrl: './images/marker-icon-black.png',
					shadowUrl: './images/marker-shadow.png',
					iconSize: [25, 41],
					iconAnchor: [12, 41],
					popupAnchor: [1, -34],
					shadowSize: [41, 41]
				});

				var startmarker = L.marker([startlat, startlng], { icon: blackIcon }).addTo(map);
				var endmarker = L.marker([endlat, endlng], { icon: goldIcon }).addTo(map);
				console.log("ready pointing!");
				// startmarker.bindPopup(`Car Number: 5`);
				// var startmarker = L.marker([1.30011, 103.8422],{ icon: greenIcon }).addTo(map);

				// var asdf = L.marker([1.30011, 103.8422]).addTo(map);


				//得到route（未编译）
				var geometryOfRoute = sampleRoute.route_geometry;

				//解码
				var polyline = L.polyline(L.PolylineUtil.decode(geometryOfRoute, 5), {
					color: "purple",
					weight: 5,
					smoothFactor: 1
				});

				//边界
				var bounds = polyline.getBounds();

				//加入线条
				polyline.addTo(map);

				//缩放到边界
				map.fitBounds(bounds);
			}
		}
	</script>
</body>

</html>